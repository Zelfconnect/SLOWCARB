#!/bin/bash
# pre-push hook — Block push without Kimi QA evidence
#
# Install: git config core.hooksPath .githooks

LAST_MSG=$(git log -1 --pretty=%B)
KIMI_QA_FLAG="/tmp/slowcarb-kimi-qa-done"

# Allow merge commits
if echo "$LAST_MSG" | grep -q "^Merge"; then
  exit 0
fi

# Check for Kimi QA evidence (flag file less than 30 min old)
if [ -f "$KIMI_QA_FLAG" ]; then
  age=$(( $(date +%s) - $(stat -f %m "$KIMI_QA_FLAG") ))
  if [ "$age" -lt 1800 ]; then
    echo "✅ Kimi QA verified ($(($age / 60))m ago)"
    rm -f "$KIMI_QA_FLAG"
    exit 0
  else
    echo "⚠️  Kimi QA flag too old ($(($age / 60))m) — run QA again"
  fi
fi

# Block
echo ""
echo "❌ Push blocked: No Kimi QA evidence"
echo ""
echo "After deploy changes, run:"
echo "  touch /tmp/slowcarb-kimi-qa-done   (after Kimi QA passes)"
echo ""
echo "Emergency bypass (Jesper only): git push --no-verify"
echo ""
exit 1
